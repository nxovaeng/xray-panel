// Minimal JS for htmx-based UI
(function () {
  'use strict';

  // Modal functions
  window.openModal = function (title) {
    const titleEl = document.getElementById('modal-title');
    if (titleEl) titleEl.textContent = title;

    const modal = document.getElementById('modal');
    if (modal) {
      modal.classList.add('show');
    }
  };

  window.closeModal = function () {
    const modal = document.getElementById('modal');
    if (modal) {
      modal.classList.remove('show');
      const body = document.getElementById('modal-body');
      if (body) body.innerHTML = '';
    }
  };

  // Notification
  window.showNotification = function (message, type = 'info') {
    const container = document.getElementById('notifications') || document.body;
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;

    // Icon based on type
    let icon = '';
    if (type === 'success') icon = '<i data-lucide="check-circle" style="color:var(--success)"></i>';
    else if (type === 'error') icon = '<i data-lucide="alert-circle" style="color:var(--danger)"></i>';
    else icon = '<i data-lucide="info" style="color:var(--accent)"></i>';

    notification.innerHTML = `${icon} <span>${message}</span>`;
    container.appendChild(notification);

    if (window.lucide) lucide.createIcons();

    // Animation
    setTimeout(() => {
      notification.style.transform = 'translateX(0)';
      notification.style.opacity = '1';
    }, 10);

    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateY(10px)';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  };

  // UUID generator
  window.generateUUID = function () {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  };

  // Logout
  window.logout = function () {
    if (confirm('Are you sure you want to logout?')) {
      // localStorage.removeItem('token'); // cookie based auth?
      fetch('/api/v1/logout', { method: 'POST' })
        .finally(() => window.location.href = '/login');
    }
  };

  // htmx event listeners
  document.body.addEventListener('htmx:afterSwap', function (evt) {
    // Only show notification/close modal for form submissions or specific actions
    const method = evt.detail.requestConfig.verb;
    if (method === 'post' || method === 'put' || method === 'delete') {
      if (evt.detail.successful) {
        // Close modal if it was a form submission inside a modal
        if (evt.detail.target.closest && (evt.detail.target.id === 'users-table' ||
          evt.detail.target.id === 'inbounds-table' ||
          evt.detail.target.id === 'domains-table' ||
          evt.detail.target.id === 'outbounds-table' ||
          evt.detail.target.id === 'routing-table')) {
          closeModal();
        }
        // Use server message if available, else generic
        // For now generic
        // showNotification('操作成功', 'success');
      }
    }

    // Re-init icons
    if (window.lucide) lucide.createIcons();
  });

  document.body.addEventListener('htmx:responseError', function (evt) {
    let msg = '请求失败';
    if (evt.detail.xhr.responseText) {
      try {
        const data = JSON.parse(evt.detail.xhr.responseText);
        if (data.error) msg = data.error;
      } catch (e) {
        msg = evt.detail.xhr.statusText;
      }
    }
    showNotification(msg, 'error');
  });

  // Modal can only be closed by X button, Cancel button, or successful form submission
  // Clicking on background will NOT close the modal to prevent accidental data loss
})();
