{{define "components/outbounds-table.html"}}
<table class="data-table">
    <thead>
        <tr>
            <th>标签</th>
            <th>协议</th>
            <th>连接详情</th>
            <th>备注</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        {{range .Outbounds}}
        <tr id="outbound-{{.ID}}">
            <td><code style="color: var(--accent); border-color: rgba(99, 102, 241, 0.2);">{{.Tag}}</code></td>
            <td>
                <span class="badge {{if eq .Type "socks5"}}badge-info{{else if eq .Type "wireguard"}}badge-success{{else if eq .Type "trojan"}}badge-warning{{else}}badge-secondary{{end}}">
                    {{if eq .Type "socks5"}}SOCKS5{{else if eq .Type "wireguard"}}WireGuard{{else if eq .Type "trojan"}}Trojan{{else}}{{.Type}}{{end}}
                </span>
            </td>
            <td style="font-family: monospace; font-size: 0.9rem; color: var(--text-secondary);">
                {{if eq .Type "socks5"}}
                    {{.Server}}:{{.Port}}
                {{else if eq .Type "wireguard"}}
                    {{.Server}}:{{.Port}}
                {{else if eq .Type "trojan"}}
                    {{.Server}}:{{.Port}}
                {{else}}
                    -
                {{end}}
            </td>
            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                {{.Remark}}
            </td>
            <td>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="testOutboundFromList('{{.ID}}')" class="btn btn-sm btn-outline"
                        style="color: var(--success); border-color: rgba(34, 197, 94, 0.3);" title="测试连接">
                        <i data-lucide="wifi" style="width: 16px; height: 16px;"></i>
                    </button>
                    <button hx-get="/outbounds/{{.ID}}/edit" hx-target="#modal-body" onclick="openModal('编辑出站')"
                        class="btn btn-sm btn-outline" title="编辑">
                        <i data-lucide="edit-2" style="width: 16px; height: 16px;"></i>
                    </button>
                    <button hx-delete="/api/outbounds/{{.ID}}" hx-target="#outbound-{{.ID}}"
                        hx-swap="outerHTML swap:0.5s" hx-confirm="确定删除此出站？" class="btn btn-sm btn-outline"
                        style="color: var(--danger); border-color: rgba(239, 68, 68, 0.3);" title="删除">
                        <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                    </button>
                </div>
            </td>
        </tr>
        {{else}}
        <tr>
            <td colspan="5" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                <i data-lucide="send" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.5;"></i>
                <div>暂无出站配置 (系统内置 Freedom/Blackhole 已自动启用)</div>
            </td>
        </tr>
        {{end}}
    </tbody>
</table>
<script>
lucide.createIcons();

// Test outbound connection from list
function testOutboundFromList(outboundId) {
    const row = document.getElementById('outbound-' + outboundId);
    const testBtn = row.querySelector('button[onclick*="testOutboundFromList"]');
    const originalContent = testBtn.innerHTML;
    
    // Show loading state
    testBtn.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i>';
    testBtn.disabled = true;
    lucide.createIcons();
    
    fetch('/api/outbounds/' + outboundId + '/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        testBtn.disabled = false;
        if (data.success) {
            testBtn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px;"></i>';
            testBtn.style.color = 'var(--success)';
            testBtn.style.borderColor = 'rgba(34, 197, 94, 0.5)';
            let message = '连接成功';
            if (data.latency_ms) {
                message += ' (' + data.latency_ms + 'ms)';
            }
            showNotification(message, 'success');
        } else {
            testBtn.innerHTML = '<i data-lucide="x" style="width: 16px; height: 16px;"></i>';
            testBtn.style.color = 'var(--danger)';
            testBtn.style.borderColor = 'rgba(239, 68, 68, 0.5)';
            showNotification('连接失败: ' + data.message, 'error');
        }
        lucide.createIcons();
        
        // Reset button after 3 seconds
        setTimeout(() => {
            testBtn.innerHTML = originalContent;
            testBtn.style.color = 'var(--success)';
            testBtn.style.borderColor = 'rgba(34, 197, 94, 0.3)';
            lucide.createIcons();
        }, 3000);
    })
    .catch(error => {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i data-lucide="x" style="width: 16px; height: 16px;"></i>';
        testBtn.style.color = 'var(--danger)';
        lucide.createIcons();
        showNotification('测试失败: ' + error.message, 'error');
        
        setTimeout(() => {
            testBtn.innerHTML = originalContent;
            testBtn.style.color = 'var(--success)';
            testBtn.style.borderColor = 'rgba(34, 197, 94, 0.3)';
            lucide.createIcons();
        }, 3000);
    });
}
</script>
{{end}}