{{define "components/routing-form.html"}}
<form hx-post="/api/routing{{if .Rule}}/{{.Rule.ID}}{{end}}" 
      hx-target="#routing-table" 
      hx-swap="innerHTML"
      hx-on::after-request="if(event.detail.successful) { closeModal(); showNotification('è·¯ç”±è§„åˆ™å·²ä¿å­˜', 'success'); } else { showNotification('ä¿å­˜å¤±è´¥: ' + event.detail.xhr.responseText, 'error'); }">

    <div class="form-group">
        <label for="name">è§„åˆ™åç§°</label>
        <input type="text" id="name" name="name" value="{{if .Rule}}{{.Rule.Name}}{{end}}" 
               placeholder="æˆ‘çš„è·¯ç”±è§„åˆ™" required>
        <small class="form-hint">ä¸ºæ­¤è§„åˆ™èµ·ä¸€ä¸ªæ˜“äºè¯†åˆ«çš„åç§°</small>
    </div>

    <div class="form-group">
        <label for="type">è§„åˆ™ç±»å‹</label>
        <select id="type" name="type" required onchange="toggleRuleFields(this.value)">
            <option value="domain" {{if and .Rule (eq .Rule.Type "domain")}}selected{{end}}>åŸŸååˆ—è¡¨ (Domain) - åŒ¹é…åŸŸå</option>
            <option value="ip" {{if and .Rule (eq .Rule.Type "ip")}}selected{{end}}>IPåˆ—è¡¨ (IP) - åŒ¹é…IPåœ°å€</option>
            <option value="geosite" {{if and .Rule (eq .Rule.Type "geosite")}}selected{{end}}>GeoSite - åŒ¹é…ç«™ç‚¹åˆ†ç±»</option>
            <option value="geoip" {{if and .Rule (eq .Rule.Type "geoip")}}selected{{end}}>GeoIP - åŒ¹é…å›½å®¶/åœ°åŒº</option>
            <option value="inbound" {{if and .Rule (eq .Rule.Type "inbound")}}selected{{end}}>å…¥ç«™ (Inbound) - åŒ¹é…æ¥æºå…¥ç«™</option>
            <option value="protocol" {{if and .Rule (eq .Rule.Type "protocol")}}selected{{end}}>åè®® (Protocol) - åŒ¹é…åè®®ç±»å‹</option>
        </select>
        <small class="form-hint">æ¯æ¡è§„åˆ™åªèƒ½åŒ¹é…ä¸€ç§ç±»å‹</small>
    </div>

    <!-- Inbound Fields -->
    <div id="inbound-fields" class="rule-fields" style="display: {{if or (not .Rule) (eq .Rule.Type "inbound")}}block{{else}}none{{end}};">
        <div class="form-group">
            <label for="inbound_tag">é€‰æ‹©å…¥ç«™</label>
            <select id="inbound_tag" name="inbound_tag">
                <option value="">è¯·é€‰æ‹©å…¥ç«™</option>
                {{range .Inbounds}}
                <option value="{{.Tag}}" {{if and $.Rule (eq $.Rule.InboundTag .Tag)}}selected{{end}}>
                    {{.Tag}} ({{.Protocol}} / {{.Port}})
                </option>
                {{end}}
            </select>
            <small class="form-hint">åŒ¹é…æ¥è‡ªç‰¹å®šå…¥ç«™çš„æµé‡ï¼Œå®ç°ä¸€å¯¹ä¸€æ˜ å°„</small>
        </div>
    </div>

    <!-- Domain Fields -->
    <div id="domain-fields" class="rule-fields" style="display: {{if and .Rule (eq .Rule.Type "domain")}}block{{else}}none{{end}};">
        <div class="form-group">
            <label for="domains">åŸŸååˆ—è¡¨</label>
            <textarea id="domains" name="domains" rows="4" placeholder="domain:google.com&#10;full:www.baidu.com&#10;regexp:.*\.cn$">{{if .Rule}}{{.Rule.Domains}}{{end}}</textarea>
            <small class="form-hint">
                æ”¯æŒæ ¼å¼ï¼š<br>
                â€¢ <code>domain:example.com</code> - åŒ¹é…åŸŸååŠå…¶å­åŸŸå<br>
                â€¢ <code>full:www.example.com</code> - å®Œå…¨åŒ¹é…<br>
                â€¢ <code>regexp:.*\.cn$</code> - æ­£åˆ™è¡¨è¾¾å¼<br>
                å¤šä¸ªè§„åˆ™ç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”
            </small>
        </div>
    </div>

    <!-- IP Fields -->
    <div id="ip-fields" class="rule-fields" style="display: {{if and .Rule (eq .Rule.Type "ip")}}block{{else}}none{{end}};">
        <div class="form-group">
            <label for="ips">IP / CIDR åˆ—è¡¨</label>
            <textarea id="ips" name="ips" rows="4" placeholder="8.8.8.8&#10;192.168.1.0/24&#10;10.0.0.0/8">{{if .Rule}}{{.Rule.IPs}}{{end}}</textarea>
            <small class="form-hint">
                æ”¯æŒæ ¼å¼ï¼š<br>
                â€¢ <code>8.8.8.8</code> - å•ä¸ªIPåœ°å€<br>
                â€¢ <code>192.168.0.0/16</code> - CIDR ç½‘æ®µ<br>
                å¤šä¸ªè§„åˆ™ç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”
            </small>
        </div>
    </div>

    <!-- GeoSite Fields -->
    <div id="geosite-fields" class="rule-fields" style="display: {{if and .Rule (eq .Rule.Type "geosite")}}block{{else}}none{{end}};">
        <div class="form-group">
            <label for="geosite_tags">GeoSite æ ‡ç­¾</label>
            <div class="input-with-button">
                <input type="text" id="geosite_tags" name="geosite_tags"
                       value="{{if .Rule}}{{.Rule.GeoSiteTags}}{{end}}"
                       placeholder="category-ads, cn, netflix, google"
                       list="geosite-datalist">
                <datalist id="geosite-datalist"></datalist>
                <button type="button" class="btn btn-secondary" onclick="loadGeoSiteTags()">åŠ è½½æ ‡ç­¾</button>
            </div>
            <small class="form-hint">
                å¸¸ç”¨æ ‡ç­¾ï¼š<br>
                â€¢ <code>category-ads</code> - å¹¿å‘ŠåŸŸå<br>
                â€¢ <code>cn</code> - ä¸­å›½å¤§é™†ç½‘ç«™<br>
                â€¢ <code>geolocation-cn</code> - ä¸­å›½å¤§é™†ç½‘ç«™ï¼ˆæ›´å…¨ï¼‰<br>
                â€¢ <code>netflix, youtube, google</code> - æµåª’ä½“/æœåŠ¡<br>
                å¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”ï¼Œç‚¹å‡»"åŠ è½½æ ‡ç­¾"å¯ä» geosite.dat è·å–å¯ç”¨æ ‡ç­¾
            </small>
        </div>
        <div id="geosite-tags-list" style="display: none; margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 10px;"></div>
    </div>

    <!-- GeoIP Fields -->
    <div id="geoip-fields" class="rule-fields" style="display: {{if and .Rule (eq .Rule.Type "geoip")}}block{{else}}none{{end}};">
        <div class="form-group">
            <label for="geoip_codes">GeoIP å›½å®¶ä»£ç </label>
            <div class="input-with-button">
                <input type="text" id="geoip_codes" name="geoip_codes"
                       value="{{if .Rule}}{{.Rule.GeoIPCodes}}{{end}}"
                       placeholder="cn, us, jp, private"
                       list="geoip-datalist">
                <datalist id="geoip-datalist"></datalist>
                <button type="button" class="btn btn-secondary" onclick="loadGeoIPCodes()">åŠ è½½ä»£ç </button>
            </div>
            <small class="form-hint">
                å¸¸ç”¨ä»£ç ï¼š<br>
                â€¢ <code>cn</code> - ä¸­å›½å¤§é™†<br>
                â€¢ <code>us</code> - ç¾å›½<br>
                â€¢ <code>private</code> - ç§æœ‰ç½‘ç»œ (192.168.x.x, 10.x.x.x)<br>
                å¤šä¸ªä»£ç ç”¨é€—å·åˆ†éš”ï¼Œç‚¹å‡»"åŠ è½½ä»£ç "å¯ä» geoip.dat è·å–å¯ç”¨ä»£ç 
            </small>
        </div>
        <div id="geoip-codes-list" style="display: none; margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 10px;"></div>
    </div>

    <!-- Protocol Fields -->
    <div id="protocol-fields" class="rule-fields" style="display: {{if and .Rule (eq .Rule.Type "protocol")}}block{{else}}none{{end}};">
        <div class="form-group">
            <label for="protocols">åè®®ç±»å‹</label>
            <input type="text" id="protocols" name="protocols" 
                   value="{{if .Rule}}{{.Rule.Protocols}}{{end}}"
                   placeholder="bittorrent, http, tls">
            <small class="form-hint">
                æ”¯æŒçš„åè®®ï¼š<br>
                â€¢ <code>bittorrent</code> - BT ä¸‹è½½<br>
                â€¢ <code>http</code> - HTTP åè®®<br>
                â€¢ <code>tls</code> - TLS/HTTPS<br>
                å¤šä¸ªåè®®ç”¨é€—å·åˆ†éš”
            </small>
        </div>
    </div>

    <!-- Target Configuration -->
    <div class="form-section" style="margin-top: 1.5rem;">
        <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border);">
            ç›®æ ‡å‡ºç«™
        </h3>

        <div class="form-group">
            <label for="outbound_tag">é€‰æ‹©å‡ºç«™</label>
            <select id="outbound_tag" name="outbound_tag" required>
                <optgroup label="ç³»ç»Ÿé»˜è®¤">
                    <option value="direct" {{if and .Rule (eq .Rule.OutboundTag "direct")}}selected{{end}}>ğŸš€ Direct (ç›´è¿)</option>
                    <option value="block" {{if and .Rule (eq .Rule.OutboundTag "block")}}selected{{end}}>ğŸš« Block (é˜»æ­¢)</option>
                </optgroup>
                {{if .Outbounds}}
                <optgroup label="ç”¨æˆ·é…ç½®">
                    {{range .Outbounds}}
                    <option value="{{.Tag}}" {{if and $.Rule (eq $.Rule.OutboundTag .Tag)}}selected{{end}}>
                        ä»£ç†: {{.Tag}} ({{.Type}})
                    </option>
                    {{end}}
                </optgroup>
                {{end}}
            </select>
            <small class="form-hint">åŒ¹é…æ­¤è§„åˆ™çš„æµé‡å°†é€šè¿‡é€‰å®šçš„å‡ºç«™å‘é€</small>
        </div>

        <div class="form-group">
            <label for="priority">ä¼˜å…ˆçº§</label>
            <input type="number" id="priority" name="priority" 
                   value="{{if .Rule}}{{.Rule.Priority}}{{else}}100{{end}}" 
                   min="1" max="1000" placeholder="100">
            <small class="form-hint">æ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå»ºè®®èŒƒå›´ 1-1000</small>
        </div>

        <div class="form-group">
            <label for="remark">å¤‡æ³¨</label>
            <textarea id="remark" name="remark" rows="2" placeholder="å¯é€‰çš„å¤‡æ³¨ä¿¡æ¯">{{if .Rule}}{{.Rule.Remark}}{{end}}</textarea>
        </div>
    </div>

    <div class="form-actions">
        <button type="button" onclick="closeModal()" class="btn">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary">
            {{if .Rule}}æ›´æ–°{{else}}åˆ›å»º{{end}}
        </button>
    </div>
</form>

<script>
    function toggleRuleFields(type) {
        const inboundFields = document.getElementById('inbound-fields');
        const domainFields = document.getElementById('domain-fields');
        const ipFields = document.getElementById('ip-fields');
        const geositeFields = document.getElementById('geosite-fields');
        const geoipFields = document.getElementById('geoip-fields');
        const protocolFields = document.getElementById('protocol-fields');
        
        if (!inboundFields || !domainFields || !ipFields || !geositeFields || !geoipFields || !protocolFields) return;
        
        // Hide all fields first
        inboundFields.style.display = 'none';
        domainFields.style.display = 'none';
        ipFields.style.display = 'none';
        geositeFields.style.display = 'none';
        geoipFields.style.display = 'none';
        protocolFields.style.display = 'none';
        
        // Remove required from all rule-specific fields
        inboundFields.querySelectorAll('input, select, textarea').forEach(el => el.removeAttribute('required'));
        domainFields.querySelectorAll('input, select, textarea').forEach(el => el.removeAttribute('required'));
        ipFields.querySelectorAll('input, select, textarea').forEach(el => el.removeAttribute('required'));
        geositeFields.querySelectorAll('input, select, textarea').forEach(el => el.removeAttribute('required'));
        geoipFields.querySelectorAll('input, select, textarea').forEach(el => el.removeAttribute('required'));
        protocolFields.querySelectorAll('input, select, textarea').forEach(el => el.removeAttribute('required'));
        
        // Show and set required for selected type
        if (type === 'inbound') {
            inboundFields.style.display = 'block';
            document.getElementById('inbound_tag').setAttribute('required', 'required');
        } else if (type === 'domain') {
            domainFields.style.display = 'block';
            document.getElementById('domains').setAttribute('required', 'required');
        } else if (type === 'ip') {
            ipFields.style.display = 'block';
            document.getElementById('ips').setAttribute('required', 'required');
        } else if (type === 'geosite') {
            geositeFields.style.display = 'block';
            document.getElementById('geosite_tags').setAttribute('required', 'required');
        } else if (type === 'geoip') {
            geoipFields.style.display = 'block';
            document.getElementById('geoip_codes').setAttribute('required', 'required');
        } else if (type === 'protocol') {
            protocolFields.style.display = 'block';
            document.getElementById('protocols').setAttribute('required', 'required');
        }
    }
    
    // Initialize immediately when script runs
    (function() {
        setTimeout(function() {
            const typeSelect = document.getElementById('type');
            if (typeSelect) {
                toggleRuleFields(typeSelect.value);
            }
        }, 10);
    })();
    
    // Cache for geodata
    let geoDataCache = null;
    
    // Load geodata from API
    function loadGeoData() {
        if (geoDataCache) {
            return Promise.resolve(geoDataCache);
        }
        
        return fetch('/api/routing/geodata')
            .then(response => response.json())
            .then(result => {
                if (result.success && result.data) {
                    geoDataCache = result.data;
                    return result.data;
                }
                throw new Error('Failed to load geodata');
            });
    }
    
    // Load GeoSite tags
    function loadGeoSiteTags() {
        const listDiv = document.getElementById('geosite-tags-list');
        const datalist = document.getElementById('geosite-datalist');
        const input = document.getElementById('geosite_tags');
        
        listDiv.style.display = 'block';
        listDiv.innerHTML = '<span style="color: var(--text-secondary);">æ­£åœ¨åŠ è½½...</span>';
        
        loadGeoData()
            .then(data => {
                if (!data.geosite_available) {
                    listDiv.innerHTML = '<span style="color: var(--warning);">geosite.dat æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ Xray èµ„æºç›®å½•é…ç½®</span>';
                    return;
                }
                
                const tags = data.geosite_tags || [];
                if (tags.length === 0) {
                    listDiv.innerHTML = '<span style="color: var(--warning);">æœªæ‰¾åˆ°ä»»ä½• GeoSite æ ‡ç­¾</span>';
                    return;
                }
                
                // Update datalist for autocomplete
                datalist.innerHTML = tags.map(tag => `<option value="${tag}">`).join('');
                
                // Show clickable tags
                listDiv.innerHTML = '<div style="margin-bottom: 8px; color: var(--text-secondary); font-size: 0.85rem;">ç‚¹å‡»æ ‡ç­¾æ·»åŠ åˆ°è¾“å…¥æ¡† (å…± ' + tags.length + ' ä¸ª):</div>' +
                    '<div style="display: flex; flex-wrap: wrap; gap: 4px;">' +
                    tags.map(tag => `<span class="badge badge-info" style="cursor: pointer;" onclick="addGeoSiteTag('${tag}')">${tag}</span>`).join('') +
                    '</div>';
            })
            .catch(error => {
                listDiv.innerHTML = '<span style="color: var(--danger);">åŠ è½½å¤±è´¥: ' + error.message + '</span>';
            });
    }
    
    // Add a GeoSite tag to the input
    function addGeoSiteTag(tag) {
        const input = document.getElementById('geosite_tags');
        const currentValue = input.value.trim();
        
        if (currentValue === '') {
            input.value = tag;
        } else {
            // Check if tag already exists
            const tags = currentValue.split(',').map(t => t.trim());
            if (!tags.includes(tag)) {
                input.value = currentValue + ', ' + tag;
            }
        }
    }
    
    // Load GeoIP codes
    function loadGeoIPCodes() {
        const listDiv = document.getElementById('geoip-codes-list');
        const datalist = document.getElementById('geoip-datalist');
        const input = document.getElementById('geoip_codes');
        
        listDiv.style.display = 'block';
        listDiv.innerHTML = '<span style="color: var(--text-secondary);">æ­£åœ¨åŠ è½½...</span>';
        
        loadGeoData()
            .then(data => {
                if (!data.geoip_available) {
                    listDiv.innerHTML = '<span style="color: var(--warning);">geoip.dat æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ Xray èµ„æºç›®å½•é…ç½®</span>';
                    return;
                }
                
                const codes = data.geoip_codes || [];
                if (codes.length === 0) {
                    listDiv.innerHTML = '<span style="color: var(--warning);">æœªæ‰¾åˆ°ä»»ä½• GeoIP ä»£ç </span>';
                    return;
                }
                
                // Update datalist for autocomplete
                datalist.innerHTML = codes.map(code => `<option value="${code}">`).join('');
                
                // Show clickable codes
                listDiv.innerHTML = '<div style="margin-bottom: 8px; color: var(--text-secondary); font-size: 0.85rem;">ç‚¹å‡»ä»£ç æ·»åŠ åˆ°è¾“å…¥æ¡† (å…± ' + codes.length + ' ä¸ª):</div>' +
                    '<div style="display: flex; flex-wrap: wrap; gap: 4px;">' +
                    codes.map(code => `<span class="badge badge-success" style="cursor: pointer;" onclick="addGeoIPCode('${code}')">${code}</span>`).join('') +
                    '</div>';
            })
            .catch(error => {
                listDiv.innerHTML = '<span style="color: var(--danger);">åŠ è½½å¤±è´¥: ' + error.message + '</span>';
            });
    }
    
    // Add a GeoIP code to the input
    function addGeoIPCode(code) {
        const input = document.getElementById('geoip_codes');
        const currentValue = input.value.trim();
        
        if (currentValue === '') {
            input.value = code;
        } else {
            // Check if code already exists
            const codes = currentValue.split(',').map(c => c.trim());
            if (!codes.includes(code)) {
                input.value = currentValue + ', ' + code;
            }
        }
    }
</script>
{{end}}