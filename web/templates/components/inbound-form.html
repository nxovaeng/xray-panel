{{define "components/inbound-form.html"}}
<form hx-post="/api/inbounds{{if .Inbound}}/{{.Inbound.ID}}{{end}}" hx-target="#inbounds-table" hx-swap="innerHTML" id="inbound-form">

    <div class="form-group">
        <label for="tag">æ ‡ç­¾</label>
        <input type="text" id="tag" name="tag" value="{{if .Inbound}}{{.Inbound.Tag}}{{end}}" required>
    </div>

    <div class="form-group">
        <label for="protocol">åè®®</label>
        <select id="protocol" name="protocol" required>
            <option value="vless" {{if and .Inbound (eq .Inbound.Protocol "vless")}}selected{{end}}>VLESS</option>
            <option value="trojan" {{if and .Inbound (eq .Inbound.Protocol "trojan")}}selected{{end}}>Trojan</option>
        </select>
        <small class="form-hint">å…¥ç«™åè®®ç±»å‹</small>
    </div>

    <div class="form-group">
        <label for="port">ç«¯å£</label>
        <div class="input-with-button">
            <input type="number" id="port" name="port" value="{{if .Inbound}}{{.Inbound.Port}}{{end}}"
                min="1024" max="65535" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
            <button type="button" class="btn btn-sm" onclick="generateRandomPort()">ğŸ² éšæœº</button>
        </div>
        <input type="hidden" id="random_port" name="random_port" value="false">
        <small class="form-hint">Xray ç›‘å¬ç«¯å£ï¼ˆç•™ç©ºæˆ–ç‚¹å‡»éšæœºè‡ªåŠ¨ç”Ÿæˆ 10000-60000 ä¹‹é—´çš„ç«¯å£ï¼‰</small>
    </div>

    <div class="form-group">
        <label for="transport">ä¼ è¾“åè®®</label>
        <select id="transport" name="transport" required onchange="toggleTransportFields(this.value)">
            <option value="xhttp" {{if and .Inbound (eq .Inbound.Transport "xhttp")}}selected{{end}}>XHTTP (æ¨è)</option>
            <option value="grpc" {{if and .Inbound (eq .Inbound.Transport "grpc")}}selected{{end}}>gRPC</option>
            <option value="ws" {{if and .Inbound (eq .Inbound.Transport "ws")}}selected{{end}}>WebSocket</option>
        </select>
        <small class="form-hint">ä¼ è¾“å±‚åè®®ï¼ˆå‡å¯è¢« Nginx åä»£ï¼‰</small>
    </div>

    <!-- WebSocket / XHTTP Fields -->
    <div id="ws-xhttp-fields" style="display: {{if or (not .Inbound) (eq .Inbound.Transport "ws") (eq .Inbound.Transport "xhttp")}}block{{else}}none{{end}};">
        <div class="form-group">
            <label for="path">è·¯å¾„</label>
            <div class="input-with-button">
                <input type="text" id="path" name="path" value="{{if .Inbound}}{{.Inbound.Path}}{{end}}"
                    placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆéšæœºè·¯å¾„">
                <button type="button" class="btn btn-sm" onclick="generateRandomPath()">ğŸ² éšæœº</button>
            </div>
            <input type="hidden" id="random_path" name="random_path" value="false">
            <small class="form-hint">WebSocket/XHTTP è·¯å¾„ï¼ˆç•™ç©ºæˆ–ç‚¹å‡»éšæœºè‡ªåŠ¨ç”Ÿæˆï¼‰</small>
        </div>
        <div class="form-group">
            <label for="host">Host (å¯é€‰)</label>
            <input type="text" id="host" name="host" value="{{if .Inbound}}{{.Inbound.Host}}{{end}}"
                placeholder="example.com">
            <small class="form-hint">Host å¤´ï¼Œé€šå¸¸ç•™ç©º</small>
        </div>
    </div>

    <!-- gRPC Fields -->
    <div id="grpc-fields" style="display: {{if and .Inbound (eq .Inbound.Transport "grpc")}}block{{else}}none{{end}};">
        <div class="form-group">
            <label for="service_name">æœåŠ¡å</label>
            <input type="text" id="service_name" name="service_name" value="{{if .Inbound}}{{.Inbound.ServiceName}}{{end}}"
                placeholder="grpc-service">
            <small class="form-hint">gRPC æœåŠ¡åç§°</small>
        </div>
    </div>

    <div class="form-group">
        <label for="domain_id">SNI åŸŸå</label>
        <select id="domain_id" name="domain_id">
            <option value="">æ— </option>
            {{range .Domains}}
            <option value="{{.ID}}" {{if and $.Inbound (eq $.Inbound.DomainID .ID)}}selected{{end}}>
                {{.Domain}}
            </option>
            {{end}}
        </select>
        <small class="form-hint">å…³è”åŸŸåï¼ˆç”¨äº SNI å’Œ Nginx è¯ä¹¦ï¼‰</small>
    </div>

    <div class="form-group">
        <label for="connect_domain">è¿æ¥ç›®æ ‡åŸŸå (å¯é€‰)</label>
        <input type="text" id="connect_domain" name="connect_domain"
            value="{{if .Inbound}}{{.Inbound.ConnectDomain}}{{end}}"
            placeholder="cdn.example.com æˆ– example.com">
        <small class="form-hint">å®¢æˆ·ç«¯å®é™…è¿æ¥çš„åŸŸåï¼ˆCDNåŸŸåæˆ–çˆ¶åŸŸåï¼‰ï¼Œç•™ç©ºåˆ™ä½¿ç”¨ SNI åŸŸå</small>
    </div>

    <div class="form-group">
        <label for="remark">å¤‡æ³¨</label>
        <textarea id="remark" name="remark" rows="2">{{if .Inbound}}{{.Inbound.Remark}}{{end}}</textarea>
    </div>

    <div class="form-actions">
        <button type="button" onclick="closeModal()" class="btn">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary">
            {{if .Inbound}}æ›´æ–°{{else}}åˆ›å»º{{end}}
        </button>
    </div>
</form>

<script>
    function toggleTransportFields(transport) {
        const wsXhttpFields = document.getElementById('ws-xhttp-fields');
        const grpcFields = document.getElementById('grpc-fields');
        
        if (transport === 'grpc') {
            wsXhttpFields.style.display = 'none';
            grpcFields.style.display = 'block';
        } else {
            wsXhttpFields.style.display = 'block';
            grpcFields.style.display = 'none';
        }
    }

    function generateRandomPort() {
        // ç”Ÿæˆ 10000-60000 ä¹‹é—´çš„éšæœºç«¯å£
        const port = Math.floor(Math.random() * 50000) + 10000;
        document.getElementById('port').value = port;
        document.getElementById('random_port').value = 'false'; // å·²ç»åœ¨å‰ç«¯ç”Ÿæˆäº†
    }

    function generateRandomPath() {
        // ç”Ÿæˆ 16 ä½éšæœºåå…­è¿›åˆ¶å­—ç¬¦ä¸²ä½œä¸ºè·¯å¾„
        const bytes = new Uint8Array(8);
        crypto.getRandomValues(bytes);
        const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        document.getElementById('path').value = '/' + hex;
        document.getElementById('random_path').value = 'false'; // å·²ç»åœ¨å‰ç«¯ç”Ÿæˆäº†
    }
</script>

<style>
    .input-with-button {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .input-with-button input {
        flex: 1;
    }
    .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
        white-space: nowrap;
    }
</style>
{{end}}