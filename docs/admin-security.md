# 管理员账户安全说明

## 概述

为了提高安全性，Xray Panel 不再使用固定的默认管理员账户。首次启动时，系统会自动生成随机的管理员凭据。

## 初始化方式

### 方式 1: 自动生成（推荐）✨

**配置文件** (`conf/config.yaml`):
```yaml
admin:
  username: ""  # 留空
  password: ""  # 留空
  email: ""     # 可选
```

**首次启动时**，系统会：
1. 生成随机用户名（格式：`admin_xxxxxx`）
2. 生成 16 位强密码（包含字母、数字、特殊字符）
3. 在控制台输出凭据

**示例输出**:
```
========================================
🔐 初始管理员账户已创建
========================================
用户名: admin_k7m2p9
密码:   Xy9mK2pL4nQ8rT6v
========================================
⚠️  请立即登录并修改密码！
⚠️  请妥善保存这些凭据，它们不会再次显示！
========================================
```

**优势**:
- ✅ 每个实例的凭据都不同
- ✅ 强密码，难以破解
- ✅ 避免使用常见的默认凭据
- ✅ 提高安全性

---

### 方式 2: 手动指定

**配置文件** (`conf/config.yaml`):
```yaml
admin:
  username: "your_admin"
  password: "YourStrongPassword123!"
  email: "admin@example.com"
```

**注意**:
- 密码长度至少 8 个字符
- 建议使用强密码（包含大小写字母、数字、特殊字符）
- 不要使用常见密码（如 admin, 123456 等）

---

## 安全建议

### 1. 首次登录后立即修改密码

即使使用自动生成的密码，也建议首次登录后修改：
1. 登录面板
2. 进入"系统设置"
3. 修改管理员密码
4. 使用密码管理器保存新密码

### 2. 使用强密码

**强密码特征**:
- 长度至少 12 个字符
- 包含大写字母 (A-Z)
- 包含小写字母 (a-z)
- 包含数字 (0-9)
- 包含特殊字符 (!@#$%^&*)
- 不包含个人信息
- 不使用常见单词

**示例强密码**:
```
Xr@y#P4n3l$2024!Sec
K9mL#2pQ@8rT6vN4xY
```

### 3. 定期更换密码

建议每 3-6 个月更换一次管理员密码。

### 4. 启用 HTTPS

生产环境必须使用 HTTPS：
- 使用 Let's Encrypt 免费证书
- 或使用自签名证书
- 配置 Nginx 反向代理

### 5. 限制访问 IP

在 Nginx 或防火墙中限制管理面板的访问 IP：

**Nginx 配置示例**:
```nginx
location / {
    # 只允许特定 IP 访问
    allow 192.168.1.100;
    allow 10.0.0.0/8;
    deny all;
    
    proxy_pass http://127.0.0.1:8082;
}
```

**防火墙规则**:
```bash
# 只允许特定 IP 访问 8082 端口
ufw allow from 192.168.1.100 to any port 8082
```

### 6. 使用非标准端口

修改默认端口 8082 为其他端口：

```yaml
server:
  listen: ":18082"  # 使用非标准端口
```

---

## 密码重置

### 方法 1: 删除数据库（重新初始化）

**警告**: 这会删除所有数据！

```bash
# 停止服务
systemctl stop xray-panel

# 删除数据库
rm /etc/xray-panel/panel.db

# 启动服务（会重新初始化）
systemctl start xray-panel

# 查看日志获取新凭据
journalctl -u xray-panel -f
```

### 方法 2: 使用重置脚本（待实现）

```bash
# 交互式重置
./scripts/reset-admin.sh

# 或直接指定
./scripts/reset-admin.sh admin_k7m2p9 NewPassword123!
```

### 方法 3: 直接操作数据库（高级）

需要 Go 环境和 bcrypt 工具：

```bash
# 安装 bcrypt 工具
go install github.com/bitnami/bcrypt-cli@latest

# 生成密码哈希
bcrypt-cli hash "NewPassword123!"

# 使用 sqlite3 更新
sqlite3 /etc/xray-panel/panel.db
> UPDATE admins SET password_hash='$2a$10$...' WHERE username='admin_k7m2p9';
> .quit
```

---

## 常见问题

### Q: 忘记了自动生成的密码怎么办？

A: 有以下几种方法：
1. 查看首次启动的日志
2. 使用密码重置脚本
3. 删除数据库重新初始化（会丢失所有数据）

### Q: 可以创建多个管理员吗？

A: 当前版本只支持单个管理员账户。未来版本会支持多管理员和权限管理。

### Q: 如何查看首次启动的日志？

A: 
```bash
# systemd 服务
journalctl -u xray-panel | grep "初始管理员"

# 或查看日志文件
cat /var/log/xray-panel.log | grep "初始管理员"
```

### Q: 自动生成的密码太复杂，可以改简单点吗？

A: 不建议。强密码是保护系统安全的第一道防线。建议：
1. 使用密码管理器（如 1Password, Bitwarden）
2. 首次登录后改为自己容易记住的强密码
3. 启用 IP 白名单限制访问

### Q: 配置文件中的密码是明文存储吗？

A: 
- 配置文件中的密码只在首次初始化时使用
- 数据库中存储的是 bcrypt 加密的哈希值
- 即使数据库泄露，密码也无法被直接读取

---

## 安全检查清单

部署前请确认：

- [ ] 已修改默认 JWT Secret
- [ ] 使用了强密码（自动生成或手动设置）
- [ ] 已保存管理员凭据到安全位置
- [ ] 启用了 HTTPS
- [ ] 配置了 IP 白名单（可选）
- [ ] 修改了默认端口（可选）
- [ ] 配置了防火墙规则
- [ ] 定期备份数据库
- [ ] 定期更新系统和依赖

---

## 总结

- ✅ 不再使用 `admin/admin12345` 等弱密码
- ✅ 自动生成随机凭据，每个实例都不同
- ✅ 支持手动指定管理员账户
- ✅ 密码使用 bcrypt 加密存储
- ✅ 提供密码重置方案
- ✅ 遵循安全最佳实践

**记住**: 安全是一个持续的过程，不是一次性的配置！
